#!/usr/bin/env node

const net = require('net');
const LPS = require('../src/LPS');
const Program = require('../src/parser/Program');

const args = process.argv.slice(2);
let serverPort = 0;

if (args.length === 0) {
  console.log('Logic Production Systems (LPS)');
  console.log('File argument to LPS program required');
  console.log('\tTry running for example: $ lps examples/bank.lps');
  process.exit(-1);
}

let file = args[0];
console.log('Loading file: ' + file);

if (args.length > 1) {
  serverPort = Number(args[1]);
}

let startTime = Date.now();
LPS.loadFile(file)
  .then((engine) => {
    console.log('File loaded in ' + (Date.now() - startTime) + 'ms');
    console.log('Cycle Interval set to ' + engine.getCycleInterval() + 'ms');
    
    engine.on('postCycle', () => {
      console.log('[ Time ' + engine.getCurrentTime() + ' ] -------------- ' + engine.getLastCycleExecutionTime() + 'ms');
      console.log('Actions:\t' + engine.getLastCycleActions());
      console.log('Fluents:\t' + engine.getActiveFluents());
      console.log('Obs:    \t' + engine.getLastCycleObservations());
      console.log('Num Rules Fired: ' + engine.getNumLastCycleFiredRules());
      console.log('Num Rules Resolved: ' + engine.getNumLastCycleResolvedRules());
      console.log('Num Rules Failed: ' + engine.getNumLastCycleFailedRules());
      console.log('');
      console.log('');
    });
    engine.on('done', () => {
      console.log('Execution complete in ' + (Date.now() - startTime) + 'ms');
      process.exit(0);
    });
    
    engine.on('error', (err) => {
      console.error(err);
      process.exit(1);
    });
    
    startTime = Date.now();    
    engine.run();

    const server = net.createServer((socket) => {
      socket.on('data', (data) => {
        let strData = data.toString('utf8');
        let literal = Program.literal(strData);
        engine.observe(literal);
      });
    });
    server.on('error', (err) => {
      console.log(err);
    });
    server.listen(serverPort, function() {
      console.log('Observation server listening on port ' + server.address().port);
    });
    
    console.log('');
  })
  .catch((err) => {
    console.log('LPS Execution Halted');
    console.log('An error has occurred');
    console.log(err);
  });
